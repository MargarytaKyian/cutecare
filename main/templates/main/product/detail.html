{% extends "main/base.html" %}
{% load static %}

{% block title %}
    {{ product.name }}
{% endblock title %}

{% block content %}
    <div class="detail-product d-flex">
        <div class="detail-img">
            {% for image in product.images.all %}
                <img class="detail-image" src="{{ image.image.url }}" alt="" style="display: none;" data-index="{{ forloop.counter0 }}">
            {% endfor %}
            <div class="image-nav">
                <button class="prev-btn">&lsaquo;</button>
                <button class="next-btn">&rsaquo;</button>
            </div>
        </div>
        <script>
            const images = document.querySelectorAll('.detail-image');
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            let currentIndex = 0;

            images[currentIndex].style.display = 'block';
            images.forEach((image, index) => {
                if (index !== currentIndex) {
                    image.style.display = 'none';
                }
            });
        
            if (images.length === 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.addEventListener('click', () => {
                    images[currentIndex].style.display = 'none';
                    currentIndex = (currentIndex - 1 + images.length) % images.length;
                    images[currentIndex].style.display = 'block';
                });
        
                nextBtn.addEventListener('click', () => {
                    images[currentIndex].style.display = 'none';
                    currentIndex = (currentIndex + 1) % images.length;
                    images[currentIndex].style.display = 'block';
                });
            }
        </script>        

        <div class="detail-description">
            <h2>{{ product.name }}</h2>
            <h3>Category: {{ product.category }}</h3>
            <p>Description: {{ product.description|linebreaks }}</p>
            {% if product.discount %}
                <div class="cart-discount d-flex gap-2">
                    <p class="line">₴{{ product.price|floatformat:2 }}</p>
                    <p>₴{{ product.sell_price|floatformat:2 }}</p>
                </div>
            {% else %}
                <p class="price">₴{{ product.price|floatformat:2 }}</p>
            {% endif %}
            <form action="{% url "cart:cart_add" product.id %}" class="qform" method="post">
                <div class="cart-form">
                    {{ cart_product_form }}
                    {% csrf_token %}
                </div>
                <input type="submit" class="add-to-cart-btn" value="Add to cart">
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-9">
            <form action="{% url 'main:submit_review' product.id %}" method="POST">
                {% csrf_token %}
                <h5>Write Your Review</h5>
                <label for="rating">How do you rate this product?</label>
                <div class="rate">
                  <input type="radio" name="rating" id="star5" value="5" required />
                  <label for="star5" title="5 stars"></label>
                  <input type="radio" name="rating" id="star4" value="4" />
                  <label for="star4" title="4 stars"></label>
                  <input type="radio" name="rating" id="star3" value="3" />
                  <label for="star3" title="3 stars"></label>
                  <input type="radio" name="rating" id="star2" value="2" />
                  <label for="star2" title="2 stars"></label>
                  <input type="radio" name="rating" id="star1" value="1" />
                  <label for="star1" title="1 star"></label>
                </div>
                <div class="mt-3">
                  <label>Review Title:</label>
                  <input type="text" class="form-control mb-2" name="subject">
                  <label>Review:</label>
                  <textarea name="review" rows="4" class="form-control mb-2"></textarea>
                </div>
                {% if user.is_authenticated %}
                  <button type="submit" class="btn btn-primary mt-2">Submit Review</button>
                {% else %}
                  <p class="text-muted mt-2">
                    You must be logged in to post a review.
                    <a href="{% url 'users:login' %}">Login Now</a>
                  </p>
                {% endif %}
              </form>              

            <header class="section-heading mt-5">
            <h3>Customer Reviews</h3>
            </header>
            <div class="customer-reviews">
            {% if reviews %}
                {% for review in reviews %}
                <div class="review mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            {% if review.user.image %}
                                <img src="{{ review.user.image.url }}" alt="Avatar"
                                     class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            {% else %}
                                <img src="{% static 'img/person-circle.svg' %}" alt="Avatar"
                                     class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover; opacity: 0.85;">
                            {% endif %}
                            <strong>{{ review.user.username }}</strong>
                        </div>
                        <small class="text-muted">{{ review.created_at|date:"d M Y" }}</small>
                    </div>                    
                    <div class="review-stars mb-2">
                        {% for star in review.star_list %}
                            {% if star == 'full' %}
                                <i class="fas fa-star"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>                    
                    {% if review.subject %}
                    <h5 class="mb-1">{{ review.subject }}</h5>
                    {% endif %}
                    <p class="mb-0">{{ review.review }}</p>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No reviews yet. Be the first to review this product!</p>
            {% endif %}
            </div>
        </div>
    </div>
{% endblock content %}